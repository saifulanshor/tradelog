<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set Password — TradeLog IDX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080a0e; --surface: #0d1117; --border: #1e2530;
      --text: #e8eaf0; --muted: #4a5568; --accent: #00e5a0;
      --danger: #ff4455; --font-display: 'Syne', sans-serif;
      --font-mono: 'DM Mono', monospace;
    }
    body {
      background: var(--bg); color: var(--text);
      font-family: var(--font-mono); min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px; width: 100%; max-width: 420px;
      margin: 20px;
    }
    .logo {
      text-align: center; margin-bottom: 32px;
    }
    .logo-text {
      font-family: var(--font-display); font-size: 28px; font-weight: 800;
      letter-spacing: -0.5px;
    }
    .logo-text span { color: var(--accent); }
    .subtitle { color: var(--muted); font-size: 12px; margin-top: 6px; }
    label {
      display: block; font-size: 11px; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--muted); margin-bottom: 6px;
    }
    input[type=password] {
      width: 100%; padding: 12px 14px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 10px;
      color: var(--text); font-family: var(--font-mono); font-size: 14px;
      outline: none; transition: border-color 0.2s; margin-bottom: 16px;
    }
    input[type=password]:focus { border-color: var(--accent); }
    .btn {
      width: 100%; padding: 14px; background: var(--accent); color: #000;
      border: none; border-radius: 10px; font-family: var(--font-display);
      font-weight: 800; font-size: 14px; cursor: pointer; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .msg {
      font-size: 12px; padding: 10px 14px; border-radius: 8px;
      margin-bottom: 16px; display: none;
    }
    .msg.error { background: rgba(255,68,85,0.1); color: var(--danger); display: block; }
    .msg.success { background: rgba(0,229,160,0.1); color: var(--accent); display: block; }
    .loading {
      text-align: center; color: var(--muted); font-size: 13px; padding: 20px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-text">TRADE<span>LOG</span></div>
      <div class="subtitle">IDX · Indonesia Stock Exchange</div>
    </div>

    <!-- Loading state -->
    <div id="state-loading" class="loading">
      Memverifikasi undangan...
    </div>

    <!-- Set password form -->
    <div id="state-form" style="display:none">
      <div style="margin-bottom:24px">
        <div style="font-family:var(--font-display);font-size:18px;font-weight:800;margin-bottom:6px">
          Buat Password
        </div>
        <div style="color:var(--muted);font-size:12px">
          Selamat datang! Buat password untuk akun kamu.
        </div>
      </div>

      <div id="msg" class="msg"></div>

      <label>Password Baru</label>
      <input type="password" id="password" placeholder="Minimal 8 karakter"/>

      <label>Konfirmasi Password</label>
      <input type="password" id="confirm" placeholder="Ulangi password"/>

      <button class="btn" id="btn" onclick="setPassword()">
        Set Password & Masuk
      </button>
    </div>

    <!-- Error state -->
    <div id="state-error" style="display:none;text-align:center">
      <div style="font-size:32px;margin-bottom:12px">⚠️</div>
      <div style="font-family:var(--font-display);font-weight:700;margin-bottom:8px">Link Tidak Valid</div>
      <div style="color:var(--muted);font-size:12px;margin-bottom:20px" id="error-msg">
        Link undangan sudah expired atau tidak valid.
      </div>
      <a href="../index.html"
        style="color:var(--accent);font-size:12px;text-decoration:none">
        ← Kembali ke Login
      </a>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script>
    const { createClient } = supabase;
    // invitation links produce an access_token in the URL fragment.  the
    // implicit flow is the one that automatically parses and stores that
    // token; PKCE is for external oauth providers and doesn't handle the
    // fragment, which is why the session was never being created.  revert
    // to implicit and call getSessionFromUrl() explicitly in init().
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        detectSessionInUrl: true,
        flowType: 'implicit',
        autoRefreshToken: true,
        persistSession: true,
      }
    });

    function show(id) {
      ['state-loading','state-form','state-error'].forEach(s => {
        document.getElementById(s).style.display = s === id ? 'block' : 'none';
      });
    }

    // Handle invitation/recovery flow
    async function init() {
      // Most of the errors we were seeing come from Supabase itself
      // (otp_expired etc) so check those first and bail early with a
      // user‑friendly message.
      const hash = window.location.hash;
      if (hash) {
        const params = new URLSearchParams(hash.slice(1));
        if (params.get('error_code')) {
          show('state-error');
          let msg = 'Link sudah kedaluwarsa atau tidak valid.';
          if (params.get('error_code') === 'otp_expired') {
            msg = 'Link sudah kedaluwarsa atau pernah dipakai. Minta admin kirim ulang.';
          }
          document.getElementById('error-msg').textContent = msg;
          return;
        }
      }

      // Force the client to parse the fragment and store the session.  the
      // built‑in automatic handling can be unreliable, so we call it
      // explicitly and log any parsing errors.
      try {
        const { error: parseError } = await sb.auth.getSessionFromUrl();
        if (parseError) console.warn('getSessionFromUrl', parseError);
      } catch (e) {
        console.warn('exception from getSessionFromUrl', e);
      }

      // give the library a moment to write the session before reading it
      await new Promise(resolve => setTimeout(resolve, 500));

      try {
        const { data, error } = await sb.auth.getSession();
        console.debug('session lookup', data, error);
        if (error) throw error;

        if (data?.session?.user) {
          show('state-form');
        } else {
          show('state-error');
          document.getElementById('error-msg').textContent =
            'Link sudah expired atau tidak valid. Minta admin untuk kirim ulang undangan.';
        }
      } catch (err) {
        console.error('Init error:', err);
        show('state-error');
        document.getElementById('error-msg').textContent =
          err.message || 'Terjadi kesalahan. Silakan coba lagi.';
      }
    }

    init();

    async function setPassword() {
      const pw  = document.getElementById('password').value;
      const pw2 = document.getElementById('confirm').value;
      const msg = document.getElementById('msg');
      const btn = document.getElementById('btn');

      msg.className = 'msg';
      msg.textContent = '';

      if (pw.length < 8) {
        msg.className = 'msg error';
        msg.textContent = 'Password minimal 8 karakter';
        return;
      }
      if (pw !== pw2) {
        msg.className = 'msg error';
        msg.textContent = 'Password tidak cocok';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const { error } = await sb.auth.updateUser({ password: pw });

      if (error) {
        msg.className = 'msg error';
        msg.textContent = 'Error: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'Set Password & Masuk';
        return;
      }

      msg.className = 'msg success';
      msg.textContent = '✓ Password berhasil dibuat! Mengalihkan ke dashboard...';
      setTimeout(() => window.location.href = 'dashboard.html', 1500);
    }

    // Enter key support
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') setPassword();
    });
  </script>
</body>
</html>